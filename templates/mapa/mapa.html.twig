{% extends 'base.html.twig' %}

{% block title %}Mapa interactivo{% endblock %}

{% block stylesheets %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
{{ encore_entry_link_tags('mapa') }}
{{ encore_entry_link_tags('app') }}
{% endblock %}

{% block content %}
<div class="mapa-interactivo-contenedor">
    <div id="map"></div>
</div>
{% include 'mapa/modal.html.twig' %}
{% endblock %}

{% block javascripts %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {

    // Inicializar el mapa centrado en La Plata
    const map = L.map('map').setView([-34.9214, -57.9544], 13);

    // Capa base OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Pines precargados
    const pins = {{ pins|json_encode|raw|default('[]') }};
    pins.forEach(pin => {
        const marker = L.marker([pin.lat, pin.lng], { draggable: true }).addTo(map);
        marker.bindPopup(`<b>${pin.title}</b><br>Lat: ${pin.lat.toFixed(5)}, Lng: ${pin.lng.toFixed(5)}
                          <br><button onclick="map.removeLayer(marker)">Eliminar</button>`);
    });

    // Referencias al modal
    const pinModal = document.getElementById('pinModal');
    const closeModalBtn = document.getElementById('closeModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const latitudeInput = document.getElementById('latitude');
    const longitudeInput = document.getElementById('longitude');

    function openModal(lat, lng) {
        latitudeInput.value = lat;
        longitudeInput.value = lng;
        pinModal.classList.remove('hidden');
        pinModal.classList.add('flex');
    }

    function closeModal() {
        pinModal.classList.add('hidden');
        pinModal.classList.remove('flex');
    }

    closeModalBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);

    // Abrir modal al hacer clic en el mapa
    map.on('click', function(e) {
        openModal(e.latlng.lat, e.latlng.lng);
    });

});

</script>
{% endblock %}
